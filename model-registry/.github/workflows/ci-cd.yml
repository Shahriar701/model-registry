name: Model Registry CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  NODE_VERSION: '18'
  AWS_REGION: 'us-east-1'

jobs:
  # Code Quality and Testing
  test:
    name: Test and Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint

      - name: Run type checking
        run: npm run build

      - name: Run unit tests
        run: npm run test:coverage

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella

      - name: Run security audit
        run: npm audit --audit-level=moderate

      - name: Cache test results
        uses: actions/cache@v3
        with:
          path: |
            coverage/
            dist/
          key: test-results-${{ github.sha }}

  # Build and Package
  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Package Lambda function
        run: |
          mkdir -p dist/lambda
          cp -r lib/src/* dist/lambda/
          cp package.json dist/lambda/
          cd dist/lambda && npm ci --production

      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-artifacts
          path: |
            dist/
            lib/
            cdk.out/
          retention-days: 7

  # Security Scanning
  security:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # Deploy to Development
  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: [test, build, security]
    if: github.ref == 'refs/heads/develop' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'dev')
    environment: development
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-artifacts

      - name: Install CDK dependencies
        run: npm ci

      - name: Deploy infrastructure
        run: |
          npx cdk deploy ModelRegistryStack-dev \
            --context environment=dev \
            --require-approval never \
            --outputs-file cdk-outputs-dev.json

      - name: Run integration tests
        run: |
          export API_GATEWAY_URL=$(cat cdk-outputs-dev.json | jq -r '.["ModelRegistryStack-dev"].ModelRegistryApiUrl')
          npm run test:integration
        env:
          NODE_ENV: test
          AWS_REGION: ${{ env.AWS_REGION }}

      - name: Upload deployment artifacts
        uses: actions/upload-artifact@v3
        with:
          name: deployment-dev
          path: cdk-outputs-dev.json

  # Deploy to Staging
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [deploy-dev]
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment: staging
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-artifacts

      - name: Install CDK dependencies
        run: npm ci

      - name: Deploy infrastructure
        run: |
          npx cdk deploy ModelRegistryStack-staging \
            --context environment=staging \
            --require-approval never \
            --outputs-file cdk-outputs-staging.json

      - name: Run smoke tests
        run: |
          export API_GATEWAY_URL=$(cat cdk-outputs-staging.json | jq -r '.["ModelRegistryStack-staging"].ModelRegistryApiUrl')
          npm run test:smoke
        env:
          NODE_ENV: staging
          AWS_REGION: ${{ env.AWS_REGION }}

      - name: Upload deployment artifacts
        uses: actions/upload-artifact@v3
        with:
          name: deployment-staging
          path: cdk-outputs-staging.json

  # Deploy to Production
  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [deploy-staging]
    if: github.ref == 'refs/heads/main' && (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod')
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_PROD }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_PROD }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-artifacts

      - name: Install CDK dependencies
        run: npm ci

      - name: Deploy infrastructure with approval
        run: |
          npx cdk deploy ModelRegistryStack-prod \
            --context environment=prod \
            --require-approval never \
            --outputs-file cdk-outputs-prod.json

      - name: Run production health checks
        run: |
          export API_GATEWAY_URL=$(cat cdk-outputs-prod.json | jq -r '.["ModelRegistryStack-prod"].ModelRegistryApiUrl')
          npm run test:health
        env:
          NODE_ENV: production
          AWS_REGION: ${{ env.AWS_REGION }}

      - name: Upload deployment artifacts
        uses: actions/upload-artifact@v3
        with:
          name: deployment-prod
          path: cdk-outputs-prod.json

      - name: Create GitHub release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.run_number }}
          release_name: Release v${{ github.run_number }}
          body: |
            ## Changes in this Release
            - Deployed to production environment
            - Build: ${{ github.sha }}
            
            ## Deployment Information
            - Environment: Production
            - Deployed at: ${{ github.event.head_commit.timestamp }}
            - Commit: ${{ github.sha }}
          draft: false
          prerelease: false

  # Rollback capability
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    if: failure() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    needs: [deploy-dev, deploy-staging, deploy-prod]
    environment: rollback
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Rollback to previous version
        run: |
          echo "Rollback functionality would be implemented here"
          echo "This could involve:"
          echo "1. Reverting to previous Lambda function version"
          echo "2. Rolling back database migrations if any"
          echo "3. Updating API Gateway to point to previous version"
          echo "4. Notifying team of rollback"

  # Cleanup old deployments
  cleanup:
    name: Cleanup Old Resources
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: [deploy-prod]
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Cleanup old Lambda versions
        run: |
          # Keep only the latest 5 versions of Lambda functions
          aws lambda list-versions-by-function \
            --function-name model-registry-prod-handler \
            --query 'Versions[?Version!=`$LATEST`]|sort_by(@, &Version)|[:-5].Version' \
            --output text | \
          xargs -I {} aws lambda delete-function \
            --function-name model-registry-prod-handler \
            --qualifier {}

      - name: Cleanup old CloudWatch logs
        run: |
          # Delete log groups older than 30 days
          aws logs describe-log-groups \
            --log-group-name-prefix "/aws/lambda/model-registry" \
            --query 'logGroups[?creationTime<`'$(date -d '30 days ago' +%s)'000`].logGroupName' \
            --output text | \
          xargs -I {} aws logs delete-log-group --log-group-name {}